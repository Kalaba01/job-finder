<!DOCTYPE html>
<html lang="<%= locale %>" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= __("TicketConversation.title", { id: ticket.id }) %></title>
    <link rel="stylesheet" href="/styles/ticket-conversation.css" />
    <link rel="icon" type="image/png" href="/images/logo.png" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  </head>
  <body id="ticketData" 
    data-ticket-id="<%= ticket.id %>" 
    data-sender-role="<%= userRole %>"
    data-user-id="<%= userId %>"
  >
    <%- include('./partials/top-bar') %>

    <div class="ticket-conversation-container">
      <h1><%= __("TicketConversation.title", { id: ticket.id }) %></h1>

      <!-- Ticket Info -->
      <div class="ticket-info">
        <p><strong><%= __("TicketConversation.info.title") %>:</strong> <%= ticket.title %></p>
        <p><strong><%= __("TicketConversation.info.description") %>:</strong> <%= ticket.description %></p>
        <p><strong><%= __("TicketConversation.info.category") %>:</strong> <%= ticket.category %></p>
        <p><strong><%= __("TicketConversation.info.status") %>:</strong> <%= ticket.status %></p>
        <p><strong><%= __("TicketConversation.info.createdAt") %>:</strong> <%= ticket.createdAt.toLocaleString() %></p>
        <p>
          <strong><%= __("TicketConversation.info.attachment") %>:</strong>
          <% if (ticket.attachment_id) { %>
            <a href="/files/<%= ticket.attachment_id %>" target="_blank" class="attachment-download">
              <i class="fa fa-download"></i>
              <%= __("TicketConversation.info.download") %>
            </a>
          <% } else { %>
            <span class="no-attachment"><em><%= __("TicketConversation.info.noAttachment") %></em></span>
          <% } %>
        </p>        
      </div>

      <!-- Messages -->
      <div id="ticketMessageList" class="ticket-message-list">
        <% messages.forEach((message) => { %>
          <div class="ticket-message <%= message.sender_id === userId ? 'sent' : 'received' %>">
            <p class="ticket-message-meta">
              <strong><%= message.sender_name %></strong>
              <span><%= new Date(message.createdAt).toLocaleString() %></span>
            </p>
            <p class="ticket-message-content"><%= message.message %></p>
          </div>          
        <% }) %>
      </div>            

      <!-- Message Input -->
      <form id="ticketMessageForm" class="ticket-message-form">
        <textarea
          id="ticketMessageInput"
          name="message"
          placeholder="<%= __("TicketConversation.form.placeholder") %>"
          required
        ></textarea>
        <button type="submit" class="ticket-send-btn"><%= __("TicketConversation.form.sendButton") %></button>
      </form>
    </div>

    <script type="module" src="/js/ticket-conversation.js"></script>
  </body>
</html>
